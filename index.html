<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Body Tune</title>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <style>
        /* =========================================
           CORE STYLES (Âü∫Êú¨Ë®≠ÂÆö)
           ========================================= */
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; 
            background: #0f1113; color: #e0e0e0; 
            padding: 20px 0; box-sizing: border-box; 
            transition: background 0.5s; 
            user-select: none; -webkit-user-select: none; /* „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÁ¶ÅÊ≠¢ */
        }
        
        :root {
            --mission-color: #ffcc00; 
            --ex-color: #ff4b2b;      
            --water-color: #0077ff;   
            --life-color: #00ff41;
            --bg-card: #1e2124;
        }

        /* =========================================
           1. CONDITION SECTION (HP„Éê„ÉºÂë®Ëæ∫)
           ========================================= */
        #vital-section { width: 90%; margin-bottom: 25px; }
        
        .label-wrap { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 12px; }
        
        .label-top { font-size: 1rem; font-weight: 900; letter-spacing: 4px; color: #777; display: flex; align-items: center; gap: 10px; }
        
        /* ÊôÇË®à„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÂ§ß„Åç„Åè„ÄÅË¶ã„ÇÑ„Åô„ÅèË™øÊï¥Ôºâ */
        #real-clock { 
            font-size: 1.4rem; /* ÊñáÂ≠ó„Çµ„Ç§„Ç∫Êã°Â§ß */
            color: var(--mission-color); 
            font-weight: bold; 
            letter-spacing: 1px;
            line-height: 1;
        }

        /* „Éë„É´„Çπ„Ç¢„Ç§„Ç≥„É≥ÔºàÂøÉÊãç„ÅÆ„Çà„ÅÜ„Å™ÁÇπÊªÖÔºâ */
        .pulse-icon { width: 12px; height: 12px; background-color: var(--life-color); border-radius: 50%; box-shadow: 0 0 10px var(--life-color); animation: pulse-ring 2s infinite ease-in-out; transition: background-color 0.3s, box-shadow 0.3s; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }

        /* HP„Éê„ÉºÊú¨‰Ωì */
        #hp-container { width: 100%; height: 60px; border: 1px solid #333; background: #000; position: relative; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 10px rgba(0,0,0,0.8); }
        #hp-bar { width: 100%; height: 100%; background: var(--life-color); transition: width 0.5s linear, background 0.3s; }
        #hp-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 2rem; color: #fff; z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }

        /* =========================================
           2. DASHBOARD („Ç∞„É™„ÉÉ„Éâ„Å®„Éú„Çø„É≥)
           ========================================= */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; width: 95%; gap: 15px; margin-bottom: 25px; }
        
        .stat-box { 
            border: 1px solid #2a2d30; padding: 40px 5px 25px; 
            text-align: center; background: linear-gradient(145deg, #1e2124, #141618); 
            border-radius: 15px; box-shadow: 5px 5px 15px #0a0b0c, -5px -5px 15px #1e2124;
            position: relative; transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        /* Undo„Éú„Çø„É≥ */
        .undo-btn { font-size: 1.2rem; color: #333; cursor: pointer; border: none; background: none; position: absolute; right: 10px; top: 12px; z-index: 20; transition: color 0.2s; }
        .undo-btn:hover { color: #888; }
        
        /* „Éö„Éº„ÇπÈÅÖ„Çå„ÅÆË≠¶ÂëäÔºàÊû†„ÅåÂÖâ„ÇãÔºâ */
        .behind-pace { border-color: var(--mission-color) !important; box-shadow: 0 0 20px rgba(255, 204, 0, 0.4) !important; }

        /* „Ç∞„É™„ÉÉ„ÉâË°®Á§∫„Ç®„É™„Ç¢ */
        .grid-container { position: relative; width: 100%; max-width: 160px; margin: 0 auto; }
        .grid-2x5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; justify-items: center; }
        
        /* Small screens: keep grid inside the card (iPhone 12 mini etc.) */
        @media (max-width: 390px) {
            .grid-2x5 { gap: 8px; }
        }
        
        /* „Çª„É´ÔºàÈÅãÂãïÔºâ */
        .cell { width: 24px; height: 35px; border: 1px solid #333; background: #000; border-radius: 4px; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); box-sizing: border-box; }
        .cell.charged { background: linear-gradient(180deg, var(--ex-color) 0%, #a31a00 100%); box-shadow: 0 4px 10px rgba(255, 75, 43, 0.4), inset 0 1px 2px rgba(255,255,255,0.4); border-color: var(--ex-color); }
        #ex-overlay-count { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; font-weight: bold; color: rgba(255, 255, 255, 0.9); text-shadow: 0 4px 25px rgba(0,0,0,1); display: none; z-index: 10; pointer-events: none;}

        /* „Ç∞„É©„ÇπÔºàÊ∞¥Ôºâ */
        .glass { width: 22px; height: 35px; border: 1px solid #444; border-radius: 2px 2px 8px 8px; position: relative; background: rgba(255,255,255,0.05); overflow: hidden; box-sizing: border-box; }
        .glass.full::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; top: 10px; background: linear-gradient(180deg, #00d4ff 0%, var(--water-color) 100%); box-shadow: inset 0 1px 2px rgba(255,255,255,0.5); }
        .glass.empty { border-color: #222; }

        /* --- BUTTON DESIGN (Áâ©ÁêÜ„Éú„Çø„É≥È¢®) --- */
        .done-btn { 
            width: 90%; height: 55px; margin: 25px auto 0; 
            border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; font-weight: 900; letter-spacing: 3px; 
            transition: transform 0.1s, box-shadow 0.2s; 
            position: relative; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .done-btn:active { transform: scale(0.96); }
        .done-btn.clicked { animation: btn-flash 0.3s ease-out; }
        @keyframes btn-flash {
            0% { background-color: rgba(255,255,255,0.2); }
            100% { background-color: transparent; }
        }

        /* ÈÅãÂãï„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .ex-done { 
            background: linear-gradient(180deg, rgba(255, 75, 43, 0.15) 0%, rgba(255, 75, 43, 0.05) 100%);
            border: 1px solid rgba(255, 75, 43, 0.6);
            box-shadow: 0 4px 12px rgba(255, 75, 43, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        /* Ê∞¥„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .water-done { 
            background: linear-gradient(180deg, rgba(0, 119, 255, 0.15) 0%, rgba(0, 119, 255, 0.05) 100%);
            border: 1px solid rgba(0, 119, 255, 0.6);
            box-shadow: 0 4px 12px rgba(0, 119, 255, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        /* =========================================
           3. MISSION & TIMER SECTION
           ========================================= */
        .action-timer-row { display: flex; width: 90%; gap: 15px; align-items: center; margin-bottom: 25px; }
        .action-column { flex: 1; display: flex; flex-direction: column; gap: 12px; }
        
        /* Êåá‰ª§Ë°®Á§∫„Éë„Éç„É´ */
        #mission-display { background: #141618; border-radius: 10px; padding: 15px; text-align: center; min-height: 2.5em; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold; color: var(--mission-color); border: 1px solid rgba(255,204,0,0.1); white-space: pre-line; }
        
        /* „É≠„Ç∞ÂÖ•ÂäõÊ¨Ñ */
        #action-input { background: #000; border: 1px solid #222; color: var(--mission-color); padding: 15px; font-size: 1.1rem; text-align: center; width: 100%; box-sizing: border-box; border-radius: 10px; }
        #action-input::placeholder { color: #333; }
        
        /* „Çø„Ç§„Éû„ÉºÂÜÜ */
        .timer-circle { 
            width: 125px; height: 125px; border-radius: 50%; 
            background: radial-gradient(circle, #1a1a1a 0%, #0a0a0a 100%);
            border: 2px solid #333; box-shadow: 5px 5px 15px #0a0b0c, -5px -5px 15px #1e2124;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        .timer-circle.active { border-color: var(--mission-color); box-shadow: 0 0 25px rgba(255, 204, 0, 0.3), inset 0 0 10px rgba(255, 204, 0, 0.1); }
        #timer-num { font-size: 5rem; font-weight: bold; color: var(--mission-color); transform: translateY(-3px); }

        /* =========================================
           4. HISTORY & CALENDAR SECTION
           ========================================= */
        #history-section { width: 90%; margin-top: 10px; }
        
        #cal-btn {
            width: 100%; padding: 15px; background: #222; border: 1px solid #333; color: #888;
            font-weight: bold; border-radius: 8px; cursor: pointer; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        #history-list { font-size: 0.8rem; color: #444; border-top: 1px solid #222; padding-top: 15px; padding-bottom: 50px; }
        .archive-entry { color: var(--life-color); font-weight: bold; padding: 10px 0; border-bottom: 1px dotted #222; }
        .log-entry { color: #666; padding: 4px 0; border-bottom: 1px solid #1a1a1a; transition: background 0.2s; }
        .log-entry span { color: #888; margin-right: 8px; font-family: monospace; }
        
        /* Âç±Ê©üÁöÑÁä∂Ê≥Å„ÅÆÁÇπÊªÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .critical-alert { animation: blink-red 1s infinite; color: #fff !important; text-shadow: 0 0 15px red !important; }
        @keyframes blink-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- „Ç´„É¨„É≥„ÉÄ„Éº„É¢„Éº„ÉÄ„É´ --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #modal-overlay.show { display: flex; opacity: 1; }
        
        #calendar-card {
            background: var(--bg-card); width: 90%; max-width: 400px;
            border-radius: 12px; padding: 20px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        #cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: #ccc; }
        .cal-nav-btn { background: #333; border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        #cal-title { font-size: 1.2rem; font-weight: bold; width: 120px; text-align: center; }
        #close-modal-btn { background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; margin-left: 10px;}

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .cal-day-label { color: #555; font-size: 0.7rem; font-weight: bold; padding-bottom: 8px; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; font-size: 0.8rem; color: #444; background: #111; position: relative;
        }
        .cal-today { border: 1px solid #fff; }
        
        /* „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÅÆËâ≤ÂàÜ„Åë */
        .lvl-0 { background: #1a1a1a; color: #444; }
        .lvl-1 { background: #0e4429; color: #ccc; } /* 1-3Âõû */
        .lvl-2 { background: #006d32; color: #fff; } /* 4-6Âõû */
        .lvl-3 { background: #26a641; color: #fff; text-shadow: 0 0 2px #000; } /* 7-9Âõû */
        .lvl-4 { background: #39d353; color: #000; font-weight: bold; box-shadow: 0 0 8px rgba(57, 211, 83, 0.4); } /* 10Âõû‰ª•‰∏ä */

    </style>
</head>
<body>

    <div id="vital-section">
        <div class="label-wrap">
            <div class="label-top"><span class="pulse-icon" id="pulse-icon"></span> CONDITION</div>
            <div id="real-clock">--:--</div>
        </div>
        <div id="hp-container">
            <div id="hp-bar"></div>
            <div id="hp-text">100%</div>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-box" id="ex-box">
            <button class="undo-btn" onclick="undoEx()">‚Ü∫</button>
            <div class="grid-container"><div id="ex-grid" class="grid-2x5"></div><div id="ex-overlay-count">0</div></div>
            <button id="btn-ex" class="done-btn ex-done" onclick="logAction()">EXERCISE</button>
        </div>
        <div class="stat-box" id="water-box">
            <button class="undo-btn" onclick="undoWater()">‚Ü∫</button>
            <div class="grid-container"><div id="water-grid" class="grid-2x5"></div></div>
            <button id="btn-water" class="done-btn water-done" onclick="drinkWater()">WATER</button>
        </div>
    </div>

    <div class="action-timer-row">
        <div class="action-column">
            <div id="mission-display">LOADING...</div>
            <input type="text" id="action-input" placeholder="RECORD LOG">
        </div>
        <div class="timer-circle" id="timer-trigger" onclick="toggleTimer()">
            <div id="timer-num">60</div>
        </div>
    </div>

    <div id="history-section">
        <button id="cal-btn" onclick="openCalendar()">
            <span>ACTIVITY LOG</span>
            <span>üìÖ</span>
        </button>
        <div id="history-list"></div>
    </div>

    <div id="modal-overlay" onclick="closeCalendar(event)">
        <div id="calendar-card">
            <div id="cal-header">
                <button class="cal-nav-btn" onclick="changeMonth(-1)">Ôºú</button>
                <div id="cal-title">-- / --</div>
                <button class="cal-nav-btn" onclick="changeMonth(1)">Ôºû</button>
                <button id="close-modal-btn" onclick="closeCalendar(event)">√ó</button>
            </div>
            <div class="cal-grid" id="cal-grid-content"></div>
            <div style="margin-top:15px; font-size:0.75rem; color:#666; text-align:right;">
                Target: 10 EX / Day
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (Ë®≠ÂÆö)
        // ==========================================
        const LS_KEY = "survival_ex_data_v5_balanced"; 
        const missions = [
            "„Éê„Éº„Éî„Éº„Ç∏„É£„É≥„Éó",
            "„É©„É≥„Ç∏",
            "„Éê„ÉÉ„ÇØ„É©„É≥„Ç∏",
            "„Çµ„Ç§„Éâ„É©„É≥„Ç∏",
            "„Çπ„ÇØ„ÉØ„ÉÉ„Éà",
            "„Éó„ÉÉ„Ç∑„É•„Ç¢„ÉÉ„Éó",
            "„Éâ„É≠„ÉÉ„Éó„É©„É≥„Ç∏",
            "„Ç∏„É£„É≥„Éî„É≥„Ç∞\n„Çπ„ÇØ„ÉØ„ÉÉ„Éà",
            "„Éó„É©„É≥„ÇØ",
            "„Éû„Ç¶„É≥„ÉÜ„É≥\n„ÇØ„É©„Ç§„Éû„Éº",
            "„Ç∏„É£„É≥„Éî„É≥„Ç∞\n„Ç∏„É£„ÉÉ„ÇØ",
            "„Çµ„Ç§„Éâ„Éô„É≥„Éà",
            "„Ç¶„Ç©„Éº„Ç≠„É≥„Ç∞\n„ÇØ„É©„É≥„ÉÅ",
            "„ÉØ„Ç§„Éâ„Çπ„ÇØ„ÉØ„ÉÉ„Éà",
            "„Ç∑„É≥„Ç∞„É´„É¨„ÉÉ„Ç∞\n„Éí„ÉÉ„Éó„É™„Éï„Éà",
            "„Ç´„Éº„Éï„É¨„Ç§„Ç∫",
            "„É¨„ÉÉ„Ç∞„É¨„Ç§„Ç∫"
        ];

        // ==========================================
        // STATE MANAGEMENT (Áä∂ÊÖãÁÆ°ÁêÜ)
        // ==========================================
        let state = {
            hp: 100,
            waterCount: 0,
            exCount: 0,
            lastSaveTime: Date.now(),
            lastDateStr: new Date().toLocaleDateString('ja-JP'),
            history: [],
            dailyLogs: {} 
        };

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let timerVal = 600; 
        let timerActive = false; 
        let timerInt = null;
        let audioCtx = null;
        let displayDate = new Date();

        // ==========================================
        // INITIALIZATION & DATA HANDLING (ÂàùÊúüÂåñ„Éª‰øùÂ≠ò)
        // ==========================================
        function loadData() {
            const saved = localStorage.getItem(LS_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    // Â±•Ê≠¥„É™„Çπ„Éà„ÅÆÂæ©ÂÖÉ
                    const list = document.getElementById('history-list');
                    if (state.history.length > 0) {
                        list.innerHTML = state.history.join('');
                    }
                } catch(e) { console.error("Data load error", e); }
            }
            
            // Ëµ∑ÂãïÊôÇ„ÅÆÊôÇÈñìÁµåÈÅéË®àÁÆó„ÉªÊó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØ
            applyTimeDecay();
            checkDateChange();
            initUI();
            updateDisplay();
        }

        function saveData() {
            // DOM„Åã„ÇâÂ±•Ê≠¥HTML„ÇíÂèñÂæó„Åó„Å¶‰øùÂ≠ò
            const list = document.getElementById('history-list');
            state.history = Array.from(list.children).slice(0, 30).map(el => el.outerHTML);
            localStorage.setItem(LS_KEY, JSON.stringify(state));
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÆüË°å
        window.onload = function() {
            loadData();
            setupAudioUnlock();
        };

        // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åã„Çâ„ÅÆÂæ©Â∏∞ÊôÇ„Å´„ÇÇ„Éá„Éº„ÇøÂêåÊúü
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') {
                loadData();
                resumeAudioIfNeeded();
            } else {
                saveData();
            }
        });

        // ==========================================
        // MAIN LOOP („É°„Ç§„É≥„É´„Éº„Éó: 1Áßí„Åî„Å®„Å´ÂÆüË°å)
        // ==========================================
        setInterval(() => {
            updateDisplay(); // ÊôÇË®à„Å®HPÊõ¥Êñ∞
            
            // 00Áßí„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„Ç™„Éº„Éà„Çª„Éº„Éñ
            if(new Date().getSeconds() === 0) saveData(); 

        }, 1000);

        // ==========================================
        // LOGIC: TIME DECAY & DATE CHANGE („É≠„Ç∏„ÉÉ„ÇØ)
        // ==========================================
        function applyTimeDecay() {
            const now = Date.now();
            const diffMs = now - state.lastSaveTime;
            
            if (diffMs < 0) {
                state.lastSaveTime = now;
                return;
            }

            const diffHours = diffMs / (1000 * 60 * 60);
            
            // HPÊ∏õÂ∞ëÁéá: 1ÊôÇÈñì„ÅÇ„Åü„ÇäÁ¥Ñ2% (48ÊôÇÈñì„Åß0)
            if (diffHours > 0) { 
                const damage = diffHours * 2.0; 
                state.hp = Math.max(0, state.hp - damage);
                state.lastSaveTime = now; 
            }
        }

        function checkDateChange() {
            const current = new Date();
            const dateStr = current.toLocaleDateString('ja-JP');

            // Êó•‰ªò„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„ÅüÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (state.lastDateStr !== dateStr) {
                if (!state.dailyLogs) state.dailyLogs = {};
                
                // Êò®Êó•„ÅÆË®òÈå≤„Çí„Ç´„É¨„É≥„ÉÄ„ÉºÁî®„Éá„Éº„Çø„Å´‰øùÂ≠ò
                state.dailyLogs[state.lastDateStr] = {
                    ex: state.exCount,
                    water: state.waterCount
                };

                // Êó•Ê¨°„É¨„Éù„Éº„Éà„ÇíÂ±•Ê≠¥„Å´ËøΩÂä†
                const logMsg = `„ÄêREPORT„Äë${state.lastDateStr} - CON: ${Math.round(state.hp)}% / EX: ${state.exCount} / H2O: ${state.waterCount}`;
                addLogToHistory(logMsg, 'archive-entry');
                
                // „Ç´„Ç¶„É≥„Éà„É™„Çª„ÉÉ„Éà
                state.exCount = 0;
                state.waterCount = 0;
                state.lastDateStr = dateStr;
                
                document.getElementById('mission-display').innerText = "SYSTEM RESET: NEW DAY";
                saveData();
                initUI();
            }
        }

        // ==========================================
        // UI UPDATES (Ë°®Á§∫Êõ¥Êñ∞)
        // ==========================================
        function initUI() {
            // ÈÅãÂãï„Ç∞„É™„ÉÉ„ÉâÂàùÊúüÂåñ
            const exGrid = document.getElementById('ex-grid');
            exGrid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const c = document.createElement('div');
                c.className = 'cell' + (i < state.exCount ? ' charged' : '');
                exGrid.appendChild(c);
            }
            // Ê∞¥„Ç∞„É™„ÉÉ„ÉâÂàùÊúüÂåñ
            const wGrid = document.getElementById('water-grid');
            wGrid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const g = document.createElement('div');
                g.className = 'glass ' + (i < state.waterCount ? 'empty' : 'full');
                wGrid.appendChild(g);
            }
            updateExDisplay();
            updateMission();
        }

        function updateDisplay() {
            const now = new Date();
            
            // „É™„Ç¢„É´„Çø„Ç§„É†Ê∏õË°∞Ë®àÁÆó
            applyTimeDecay(); 
            const hp = state.hp; 

            // HP„Éê„Éº„Å®Ëâ≤„ÅÆÂà∂Âæ°
            const hpBar = document.getElementById('hp-bar');
            const hpText = document.getElementById('hp-text');
            const pulseIcon = document.getElementById('pulse-icon');
            let color1, color2;
            hpText.classList.remove('critical-alert');

            if (hp >= 50) {
                color1 = '#00ff41'; color2 = '#008f25';
                pulseIcon.style.backgroundColor = '#00ff41'; pulseIcon.style.boxShadow = '0 0 10px #00ff41';
            } else if (hp >= 20) {
                color1 = '#ffaa00'; color2 = '#cc8800'; 
                pulseIcon.style.backgroundColor = '#ffaa00'; pulseIcon.style.boxShadow = '0 0 10px #ffaa00';
            } else if (hp >= 10) {
                color1 = '#ff4b2b'; color2 = '#8b0000';
                pulseIcon.style.backgroundColor = '#ff4b2b'; pulseIcon.style.boxShadow = '0 0 10px #ff4b2b';
            } else {
                color1 = '#ff0000'; color2 = '#300000';
                hpText.classList.add('critical-alert');
                pulseIcon.style.backgroundColor = '#ff0000'; pulseIcon.style.boxShadow = '0 0 15px #ff0000';
            }

            hpBar.style.background = `linear-gradient(180deg, ${color1} 0%, ${color2} 100%)`;
            hpBar.style.width = hp + '%';
            hpText.innerText = Math.round(hp) + "%";
            
            // ÊôÇË®àÊõ¥Êñ∞ (REALË°®Ë®ò„Å™„Åó)
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('real-clock').innerText = `${h}:${m}`;

            // „Éö„Éº„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
            checkPace(now.getHours(), now.getMinutes());
        }

        function checkPace(hour, min) {
            let target = 0;
            // 8:00„Äú20:00„ÅÆÈñì„ÅØ72ÂàÜ„Åî„Å®„Å´ÁõÆÊ®ô„ÅåÂ¢ó„Åà„Çã
            if (hour >= 8 && hour < 20) {
                const elapsedMin = (hour - 8) * 60 + min;
                target = Math.floor(elapsedMin / 72); 
            } else if (hour >= 20) { target = 10; }
            
            // ÈÅÖ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊû†„ÇíÂÖâ„Çâ„Åõ„Çã
            if (target > 0) {
                document.getElementById('ex-box').classList.toggle('behind-pace', state.exCount < target);
                document.getElementById('water-box').classList.toggle('behind-pace', state.waterCount < target);
            } else {
                document.getElementById('ex-box').classList.remove('behind-pace');
                document.getElementById('water-box').classList.remove('behind-pace');
            }
        }

        function updateExDisplay() {
            // 10Âõû„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅÆ„Ç´„Ç¶„É≥„ÉàË°®Á§∫
            const overlay = document.getElementById('ex-overlay-count');
            if (state.exCount >= 10) { overlay.innerText = state.exCount; overlay.style.display = 'block'; }
            else { overlay.style.display = 'none'; }
        }

        function updateMission() {
            // „É©„É≥„ÉÄ„É†„Å´Êåá‰ª§„ÇíË°®Á§∫
            document.getElementById('mission-display').innerText = missions[Math.floor(Math.random() * missions.length)];
        }

        // ==========================================
        // ACTIONS („É¶„Éº„Ç∂„ÉºÊìç‰Ωú)
        // ==========================================
        function logAction() {
            checkDateChange();
            applyTimeDecay(); 
            triggerBtnAnim('btn-ex'); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            playExerciseSound();      // Èü≥

            // HPÂõûÂæ© & ÂõûÊï∞Âä†ÁÆó
            state.hp = Math.min(100, state.hp + 5);
            if (state.exCount < 10) document.getElementsByClassName('cell')[state.exCount].classList.add('charged');
            state.exCount++;

            // „É≠„Ç∞ÁîüÊàê
            const input = document.getElementById('action-input');
            const mission = document.getElementById('mission-display').innerText;
            const actionName = input.value || mission;
            const d = new Date();
            const h = d.getHours().toString().padStart(2, '0');
            const m = d.getMinutes().toString().padStart(2, '0');
            
            addLogToHistory(`<span>[${h}:${m}]</span> EX: ${actionName}`, 'log-entry');
            input.value = ""; // ÂÖ•ÂäõÊ¨Ñ„ÇØ„É™„Ç¢

            updateExDisplay();
            updateMission();
            updateDisplay(); 
            saveData();
        }

        function drinkWater() {
            checkDateChange();
            applyTimeDecay(); 
            triggerBtnAnim('btn-water');
            playWaterSound();

            if (state.waterCount >= 10) return;
            document.getElementsByClassName('glass')[state.waterCount].className = 'glass empty';
            state.waterCount++;
            state.hp = Math.min(100, state.hp + 1);

            const d = new Date();
            const h = d.getHours().toString().padStart(2, '0');
            const m = d.getMinutes().toString().padStart(2, '0');
            addLogToHistory(`<span>[${h}:${m}]</span> H2O: Resupply`, 'log-entry');

            updateDisplay(); 
            saveData();
        }

        function undoEx() { 
            if (state.exCount > 0) { 
                state.exCount--; 
                removeLastLog('EX:'); // ÊúÄÊñ∞„ÅÆ„É≠„Ç∞„ÇíÂâäÈô§
                initUI(); 
                updateDisplay();
                saveData(); 
            } 
        }

        function undoWater() { 
            if (state.waterCount > 0) { 
                state.waterCount--; 
                removeLastLog('H2O:'); // ÊúÄÊñ∞„ÅÆ„É≠„Ç∞„ÇíÂâäÈô§
                initUI(); 
                updateDisplay(); 
                saveData(); 
            } 
        }

        // ==========================================
        // HISTORY LIST UTILS (Â±•Ê≠¥„É™„Çπ„ÉàÊìç‰Ωú)
        // ==========================================
        function addLogToHistory(htmlContent, className) {
            const list = document.getElementById('history-list');
            const div = document.createElement('div');
            div.className = className;
            div.innerHTML = htmlContent;
            list.prepend(div);
            // Â±•Ê≠¥„ÅØÊúÄÊñ∞50‰ª∂„Åæ„Åß‰øùÊåÅ
            if(list.children.length > 50) list.removeChild(list.lastChild);
        }

        function removeLastLog(type) {
            const list = document.getElementById('history-list');
            const entries = list.getElementsByClassName('log-entry');
            for (let i = 0; i < entries.length; i++) {
                if (entries[i].innerHTML.includes(type)) {
                    list.removeChild(entries[i]);
                    break; 
                }
            }
        }

        // ==========================================
        // AUDIO & EFFECTS (Èü≥„Å®„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥)
        // ==========================================
        function resumeAudioIfNeeded() {
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().catch(() => {});
            }
        }

        function setupAudioUnlock() {
            const unlock = () => {
                initAudio();
                resumeAudioIfNeeded();
            };

            document.addEventListener('pointerdown', unlock, { once: true });
            document.addEventListener('touchstart', unlock, { once: true });
            document.addEventListener('keydown', unlock, { once: true });
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            resumeAudioIfNeeded();
        }

        function triggerBtnAnim(btnId) {
            const btn = document.getElementById(btnId);
            btn.classList.remove('clicked');
            void btn.offsetWidth; // „É™„Éï„É≠„ÉºÂº∑Âà∂
            btn.classList.add('clicked');
        }

        function playExerciseSound() {
            initAudio();
            const now = audioCtx.currentTime;
            // „É°„Ç∏„É£„Éº„Ç≥„Éº„Éâ„ÅÆ„Ç¢„É´„Éö„Ç∏„Ç™ (C -> E -> G)
            const freqs = [523.25, 659.25, 783.99]; 
            freqs.forEach((f, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(f, now + i * 0.08);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0, now + i * 0.08);
                gain.gain.linearRampToValueAtTime(0.1, now + i * 0.08 + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.3);
                osc.start(now + i * 0.08);
                osc.stop(now + i * 0.08 + 0.3);
            });
        }

        function playWaterSound() {
            initAudio();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            // „Éî„ÉÉ„ÉÅ„Éô„É≥„Éâ„ÅßÊ∞¥Èü≥„ÇíË°®Áèæ
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc.start(now);
            osc.stop(now + 0.15);
        }

        function playBeep(freq, count = 1, duration = 0.1) {
            initAudio();
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.connect(g); g.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    g.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    osc.start(); osc.stop(audioCtx.currentTime + duration);
                }, i * 200);
            }
        }

        // ==========================================
        // TIMER LOGIC („Çø„Ç§„Éû„Éº)
        // ==========================================
        function toggleTimer() {
            const wrap = document.getElementById('timer-trigger');
            if (timerActive) {
                clearInterval(timerInt);
                timerActive = false;
                wrap.classList.remove('active');
            } else {
                initAudio();
                if(timerVal <= 0) timerVal = 600;
                timerActive = true;
                wrap.classList.add('active'); 
                timerInt = setInterval(() => {
                    timerVal--;
                    document.getElementById('timer-num').innerText = Math.ceil(timerVal/10);
                    // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥
                    if (timerVal === 350 || timerVal === 300) playBeep(880); 
                    if (timerVal <= 50 && timerVal > 0 && timerVal % 10 === 0) playBeep(880); 
                    if (timerVal === 0) {
                        playBeep(440, 3, 0.15);
                        toggleTimer();
                    }
                }, 100);
            }
        }

        // ==========================================
        // CALENDAR SYSTEM („Ç´„É¨„É≥„ÉÄ„Éº)
        // ==========================================
        function openCalendar() {
            displayDate = new Date();
            renderCalendar();
            const modal = document.getElementById('modal-overlay');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeCalendar(e) {
            if (e.target.id === 'modal-overlay' || e.target.id === 'close-modal-btn') {
                const modal = document.getElementById('modal-overlay');
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        function changeMonth(offset) {
            displayDate.setMonth(displayDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth(); 
            
            document.getElementById('cal-title').innerText = `${year} / ${(month + 1).toString().padStart(2, '0')}`;
            const grid = document.getElementById('cal-grid-content');
            grid.innerHTML = '';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'cal-day-label';
                div.innerText = d;
                grid.appendChild(div);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for(let d=1; d<=lastDate; d++) {
                const cell = document.createElement('div');
                cell.className = 'cal-day';
                cell.innerText = d;

                const currentD = new Date(year, month, d);
                const dateKey = currentD.toLocaleDateString('ja-JP');

                let exVal = 0;
                const todayStr = new Date().toLocaleDateString('ja-JP');
                
                // ‰ªäÊó•„ÅÆ„Éá„Éº„Çø „Åæ„Åü„ÅØ ÈÅéÂéª„É≠„Ç∞„Åã„ÇâÂõûÊï∞„ÇíÂèñÂæó
                if (dateKey === todayStr) {
                    exVal = state.exCount;
                    cell.classList.add('cal-today');
                } else if (state.dailyLogs && state.dailyLogs[dateKey]) {
                    exVal = state.dailyLogs[dateKey].ex || 0;
                }

                // „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÅÆËâ≤‰ªò„Åë
                if (exVal >= 10) cell.classList.add('lvl-4');
                else if (exVal >= 7) cell.classList.add('lvl-3');
                else if (exVal >= 4) cell.classList.add('lvl-2');
                else if (exVal >= 1) cell.classList.add('lvl-1');
                else cell.classList.add('lvl-0');

                grid.appendChild(cell);
            }
        }
    </script>
</body>
</html>
